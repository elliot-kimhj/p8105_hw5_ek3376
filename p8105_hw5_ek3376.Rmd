---
title: "p8105_hw5_ek3376"
author: "ek3376"
date: "2024-11-15"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rvest)
library(broom)
```

## Problem 1

```{r}
set.seed(1)

birthday_duplicates = function(birthday) {
  birthdays <- sample(1:365, x, replace = TRUE)
  if (length(unique(birthdays)) < length(birthdays)) {
    return(TRUE)
  }
    else {
    return(FALSE)  
  }
}
```


## Problem 2

Below we define a simulation function for exploring the power of a one-sample t-test. We observe the associated power of mu values 0 through 6.

```{r}
set.seed(12)

n <- 30
sigma <- 5
alpha <- 0.05
nsim <- 5000
mu_values = 0:6


power_sim <- function(n, mu, sigma) {
  mu_hat <- numeric(nsim)
  p_value <- numeric(nsim)
  for (i in 1:nsim) {
    data <- rnorm(n, mean = mu, sd = sigma)
    t_test_result <- t.test(data, mu = 0)
    tidy_result <- broom::tidy(t_test_result) 
    mu_hat[i] <- tidy_result$estimate
    p_value[i] <- tidy_result$p.value
  }
  results <- tibble(mu_hat = mu_hat, p_value = p_value)
  return(results)
}

power_results <- numeric(length(mu_values))
avg_mu_hat <- numeric(length(mu_values))
avg_mu_hat_reject <- numeric(length(mu_values))

for (i in 1:length(mu_values)) {
  mu <- mu_values[i]
  results <- power_sim(n = n, mu = mu, sigma = sigma)
  power_results[i] <- mean(results$p_value < alpha)
  avg_mu_hat[i] <- mean(results$mu_hat)
  avg_mu_hat_reject[i] <- mean(results$mu_hat[results$p_value < alpha])
}

results <- tibble(
  mu_values = mu_values, 
  power = power_results,
  avg_mu_hat = avg_mu_hat,
  avg_mu_hat_reject = avg_mu_hat_reject
)
```

Below we plot the results of the proportion of times null was rejected versus the true value of mu. Based on the plot, the power of the test increases as the true value of mu increases, with a plateau/level off at mu values 5 and 6 as the power has reached 1.

```{r}
ggplot(results, aes(x = mu_values, y = power)) + 
  geom_line() + geom_point() + labs(
    title = "Proportion of Null Rejections vs. True Value of Mu"
  ) 
```

Below we plot the average estimate of mu hat versus the true value of mu. Additionally, we make a second plot overlayed showing the average estimate of mu hat only in samples for which the null was rejected versus the true value of mu. Based on the plots, the sample average of mu hat across all tests is equal to the true value of mu. On the other hand, the sample average of mu hat across tests for which the null is rejected is not equal to the true value of mu. The estimated mu hat is larger than the true value of mu for mu greater than 0 and this difference levels off for larger values of mu until mu = 6. This difference is the result of bias since we are selecting samples where mu hat was farther from 0 skewing the avergae of mu hat. 

```{r}
ggplot(results, aes(x = mu_values)) + 
  geom_line(aes(y = avg_mu_hat, color = "All")) + 
  geom_point(aes(y = avg_mu_hat, color = "All")) + 
  geom_line(aes(y = avg_mu_hat_reject, color = "Rejected")) + 
  geom_point(aes(y = avg_mu_hat_reject, color = "Rejected")) + 
  labs(
    title = "Average Estimate of Mu hat vs. True Value of Mu",
    x = "True Value of Mu",
    y = "Average Estimate of Mu hat",
    color = "Sample"
  )
```

## Problem 3

Below we import the homicide dataset from the Washington Post. Based on the raw data, this dataset describes homicides in 50 large U.S. cities.

```{r}
homicide_wp <- read_csv("data/homicide-data.csv")
```
The raw dataset for homicide_wp has `r nrow(homicide_wp) - 1` total observations and `r ncol(homicide_wp)` variables. The variables include `r names(homicide_wp`.

Below we create a city_state variable and summarize within cities to obtain the total number of homicides and the number of unsolved homcides (those for which the disposition is "Closed without arrest" or "Open/No arrest"). 

```{r}
homicide2 <- homicide_wp |>
  mutate(city_state = paste(city, state, sep = ", "))

city_summary <- homicide2 |>
  group_by(city_state) |>
  summarise(
    total_homicides = n(),
    unsolved_homicides = sum(disposition %in% c("Closed without arrest", "Open/No arrest"), na.rm = TRUE)
  )

head(city_summary)
```

Below we use the prop.test function to estimate the proportion of homicides that are unsolved, save the output as an R object, apply broom::tidy to this object to obtain a tidy dataframe, and pull the estimated proportion and confidence intervals from the resulting dataframe. 

```{r}
baltimore_homicide <- homicide2 |>
  filter(city_state == "Baltimore, MD")

baltimore_summary <- baltimore_homicide |>
  summarise(
   total_homicide_baltimore = n(),
   unsolved_homicide_baltimore = sum(disposition %in% c("Closed without arrest", "Open/No arrest"), na.rm = TRUE)
  )

prop_test_output <- prop.test(
  x = baltimore_summary$unsolved_homicide_baltimore, 
  n = baltimore_summary$total_homicide_baltimore,
  conf.level = 0.95)

prop_test_output_tidy <- broom::tidy(prop_test_output)

estimated_proportion <- prop_test_output_tidy$estimate
conf_low <- prop_test_output_tidy$conf.low 
conf_high <- prop_test_output_tidy$conf.high 
```

Below we repeat the process for all cities in the dataset, extracting both the proportion of unsolved homicides and the confidence interval for each. 

```{r}
city_prop_results <- city_summary |>
  mutate(
    city_prop_test = purrr::map2(
      .x = unsolved_homicides, 
      .y = total_homicides,
      .f = ~ broom::tidy(prop.test(x = .x, n = .y, conf.level = 0.95))
    )
  ) |>
  unnest(cols = c(city_prop_test)) |>
  select(city_state, total_homicides, unsolved_homicides, estimate, conf.low, conf.high)
```

Below we create a plot showing the estimates and CIs for each city and organize the cities according to the proportion of unsolved homicides. 

```{r}
ggplot(city_prop_results, aes(x = reorder(city_state, estimate), y = estimate)) +
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.3) + 
  labs(
    title = "Proportion of Unsolved Homicides by US City",
    x = "City", 
    y = "Proportion of Unsolved Homicide", 
  )
```
